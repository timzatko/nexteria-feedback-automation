<html>
    <head>
        <link rel="shortcut icon" href="#" />
    </head>
    <body>
        <div id="results"></div>
        <script defer src="https://apis.google.com/js/api.js"></script>
        <script defer>
            GoogleAuth = undefined;

            function calculateNpsMetrics(npsScores, responseCount) {
                let promoterCount = 0;
                let detractorCount = 0;

                npsScores.forEach(npsScore => {
                    if (npsScore >= 9) {
                        promoterCount += 1;
                    } else if (npsScore < 7) {
                        detractorCount += 1;
                    }
                });

                const nps_promoter_percentage = (promoterCount / responseCount) * 100;
                const nps_detractor_percentage = (detractorCount / responseCount) * 100;

                return {
                    nps_promoter_percentage,
                    nps_detractor_percentage,
                };
            }

            function processSpreadsheetData(columnData) {
                console.log(columnData);
                const response_count = columnData[1].length;
                const npsScores = columnData[2];
                const { nps_promoter_percentage, nps_detractor_percentage } = calculateNpsMetrics(
                    npsScores,
                    response_count,
                );

                const comments_rating = columnData[3];
                const comments_outcome = columnData[4];
                const comments_appreciation = columnData[5];
                const comments_suggestions = columnData[6];
                const comments_other = columnData[7];

                return {
                    response_count,
                    nps_promoter_percentage,
                    nps_detractor_percentage,
                    comments_rating,
                    comments_outcome,
                    comments_appreciation,
                    comments_suggestions,
                    comments_other,
                };
            }

            async function getSpreadsheetData() {
                const params = {
                    // The spreadsheet to request.
                    spreadsheetId: '1Z4WXj3utPnatIVk37jqB5RhYuCwOAxJJjhuBTJ2vA3A',
                    fields: 'sheets',
                };

                const response = await gapi.client.sheets.spreadsheets.get(params);
                const rawRowData = response.result.sheets[0].data[0].rowData;
                const rowData = rawRowData.map(row => {
                    const rowCells = row.values.map(rowCell => {
                        if (rowCell.userEnteredValue) {
                            if (rowCell.userEnteredValue.stringValue) {
                                return rowCell.userEnteredValue.stringValue;
                            } else if (rowCell.userEnteredValue.numberValue) {
                                return String(rowCell.userEnteredValue.numberValue);
                            } else {
                                return '';
                            }
                        }
                    });
                    return rowCells;
                });

                // row[0] -> Header row with questions
                const columnCount = rowData[0].length;
                const columnData = [];
                for (let i = 0; i < columnCount; i++) {
                    columnData.push([]);
                }

                rowData.forEach((row, index) => {
                    // First row -> Header (no responses)
                    if (index === 0) {
                        return;
                    }
                    // row[1] -> Email (required; no value -> invalid)
                    if (typeof row[1] === 'undefined' || row[1].trim() === '') {
                        return;
                    }

                    for (let i = 0; i < columnCount; i++) {
                        if (typeof row[i] !== 'undefined' && row[i].trim() !== '') {
                            columnData[i].push(row[i]);
                        }
                    }
                });

                return columnData;
            }

            async function updateSigninStatus(isSignedIn) {
                console.debug('updateSigninStatus: ', { isSignedIn });

                const GoogleAuth = gapi.auth2.getAuthInstance();
                if (!GoogleAuth.isSignedIn.get()) {
                    GoogleAuth.signIn();
                } else {
                    const columnData = getSpreadsheetData();
                    console.log(processSpreadsheetData(columnData));
                }
            }

            // http-server -a localhost -p 8080 zz_temp
            async function initClient() {
                console.debug('>>> Client and OAuth2 modules have been loaded.');

                await gapi.client.init({
                    apiKey: 'AIzaSyBo_yuyYq95Old07qTCjhpGaffMdUi1Ayo',
                    clientId: '345256225015-eecv2hcnteg0k5o1pe9v5l0qbhpc5213.apps.googleusercontent.com',
                    scope:
                        'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/spreadsheets.readonly',
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });

                console.log('>>> Client has been initialized.');

                const GoogleAuth = gapi.auth2.getAuthInstance();
                console.debug({ GoogleAuth });

                GoogleAuth.isSignedIn.listen(updateSigninStatus);

                const user = GoogleAuth.currentUser.get();
                console.debug({ user });
                if (!GoogleAuth.isSignedIn.get()) {
                    GoogleAuth.signIn();
                } else {
                    const columnData = await getSpreadsheetData();
                    console.log(processSpreadsheetData(columnData));
                }
            }

            async function handleClientLoad() {
                gapi.load('client:auth2', initClient);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', handleClientLoad);
            } else {
                handleClientLoad();
            }
        </script>
    </body>
</html>
